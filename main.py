import random
import requests
import logging
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext

BOT_TOKEN = "7882447585:AAFRX4Q6eqhN5uoJvv45O3ACrY7fvFFF2nI"
ADMIN_ID = 6212199357

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ุฃุฐูุงุฑ (ููุณ ุงูููุงุฆู ุงูุณุงุจูุฉ)
MORNING_ADHKAR = [
    "ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุจู ุฃุตุจุญูุงุ ูุจู ุฃูุณููุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุดูุฑ.",
    "ุณุจุญุงู ุงููู ูุจุญูุฏู ุนุฏุฏ ุฎููู ูุฑุถุง ููุณู ูุฒูุฉ ุนุฑุดู ููุฏุงุฏ ูููุงุชู.",
    "ุงูููู ุฅูู ุฃุตุจุญุช ููู ูู ูุนูุฉ ูุนุงููุฉ ูุณุชุฑุ ูุฃุชู ูุนูุชู ุนูู ูุนุงููุชู ูุณุชุฑู ูู ุงูุฏููุง ูุงูุขุฎุฑุฉ.",
    "ุฃุตุจุญูุง ุนูู ูุทุฑุฉ ุงูุฅุณูุงูุ ููููุฉ ุงูุฅุฎูุงุตุ ูุฏูู ูุจููุง ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ ูููุฉ ุฃุจููุง ุฅุจุฑุงููู ุญูููุงู ูุณููุงู ููุง ูุงู ูู ุงููุดุฑููู.",
    "ุงูููู ูุง ุฃุตุจุญ ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ.",
    "ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ููุ ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู.",
    "ุงูููู ุฅูู ุฃุณุฃูู ุนููุงู ูุงูุนุงูุ ูุฑุฒูุงู ุทูุจุงูุ ูุนููุงู ูุชูุจูุงู.",
    "ุณุจุญุงู ุงููู ุงูุนุธูู ูุจุญูุฏูุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู."
]

EVENING_ADHKAR = [
    "ุฃูุณููุง ูุฃูุณู ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุจู ุฃูุณููุงุ ูุจู ุฃุตุจุญูุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุตูุฑ.",
    "ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู.",
    "ุงูููู ุฅูู ุฃูุณูุช ููู ูู ูุนูุฉ ูุนุงููุฉ ูุณุชุฑุ ูุฃุชู ูุนูุชู ุนูู ูุนุงููุชู ูุณุชุฑู ูู ุงูุฏููุง ูุงูุขุฎุฑุฉ.",
    "ุฃูุณููุง ุนูู ูุทุฑุฉ ุงูุฅุณูุงูุ ููููุฉ ุงูุฅุฎูุงุตุ ูุฏูู ูุจููุง ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ ูููุฉ ุฃุจููุง ุฅุจุฑุงููู ุญูููุงู ูุณููุงู ููุง ูุงู ูู ุงููุดุฑููู.",
    "ุงูููู ูุง ุฃูุณู ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ.",
    "ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ููุ ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู.",
    "ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ ูู ุงูุฏููุง ูุงูุขุฎุฑุฉุ ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ ูู ุฏููู ูุฏููุงู ูุฃููู ููุงูู.",
    "ุณุจุญุงู ุงููู ุงูุนุธูู ูุจุญูุฏูุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุฃุนูุฐ ุจุงููู ูู ุงูุดูุทุงู ุงูุฑุฌูู: {ุขูุฉ ุงููุฑุณู}"
]

NIGHT_ADHKAR = [
    "ุจุงุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู.",
    "ุขูุฉ ุงููุฑุณู: ุงููู ูุง ุฅูู ุฅูุง ูู ุงูุญู ุงููููู ูุง ุชุฃุฎุฐู ุณูุฉ ููุง ููู ูู ูุง ูู ุงูุณูุงูุงุช ููุง ูู ุงูุฃุฑุถ...",
    "ุฃุนูุฐ ุจุฑุจ ุงููููุ ูู ุดุฑ ูุง ุฎููุ ููู ุดุฑ ุบุงุณู ุฅุฐุง ููุจุ ููู ุดุฑ ุงูููุงุซุงุช ูู ุงูุนูุฏุ ููู ุดุฑ ุญุงุณุฏ ุฅุฐุง ุญุณุฏ.",
    "ุฃุนูุฐ ุจุฑุจ ุงููุงุณุ ููู ุงููุงุณุ ุฅูู ุงููุงุณุ ูู ุดุฑ ุงููุณูุงุณ ุงูุฎูุงุณุ ุงูุฐู ููุณูุณ ูู ุตุฏูุฑ ุงููุงุณุ ูู ุงูุฌูุฉ ูุงููุงุณ.",
    "ุงูููู ุฑุจ ุงูุณูุงูุงุช ูุฑุจ ุงูุฃุฑุถ ูุฑุจ ุงูุนุฑุด ุงูุนุธููุ ุฑุจูุง ูุฑุจ ูู ุดูุกุ ูุงูู ุงูุญุจ ูุงููููุ ูููุฒู ุงูุชูุฑุงุฉ ูุงูุฅูุฌูู ูุงููุฑูุงูุ ุฃุนูุฐ ุจู ูู ุดุฑ ูู ุดูุก ุฃูุช ุขุฎุฐ ุจูุงุตูุชูุ ุงูููู ุฃูุช ุงูุฃูู ูููุณ ูุจูู ุดูุกุ ูุฃูุช ุงูุขุฎุฑ ูููุณ ุจุนุฏู ุดูุกุ ูุฃูุช ุงูุธุงูุฑ ูููุณ ูููู ุดูุกุ ูุฃูุช ุงูุจุงุทู ูููุณ ุฏููู ุดูุกุ ุงูุถ ุนูุง ุงูุฏูู ูุฃุบููุง ูู ุงูููุฑ.",
    "ุจุณู ุงููู ูุถุนุช ุฌูุจูุ ุงูููู ุงุบูุฑ ูู ุฐูุจูุ ูุฃุฎุณุฆ ุดูุทุงููุ ููู ุฑูุงููุ ูุงุฌุนููู ูู ุงููุฏู ุงูุฃุนูู.",
    "ุงูููู ุฃุณููุช ููุณู ุฅูููุ ููุฌูุช ูุฌูู ุฅูููุ ูููุถุช ุฃูุฑู ุฅูููุ ูุฃูุฌุฃุช ุธูุฑู ุฅูููุ ุฑุบุจุฉ ูุฑูุจุฉ ุฅูููุ ูุง ููุฌุฃ ููุง ููุฌุง ููู ุฅูุง ุฅูููุ ุขููุช ุจูุชุงุจู ุงูุฐู ุฃูุฒูุชุ ูุจูุจูู ุงูุฐู ุฃุฑุณูุช.",
    "ุณุจุญุงู ุงููู (33 ูุฑุฉ)ุ ุงูุญูุฏ ููู (33 ูุฑุฉ)ุ ุงููู ุฃูุจุฑ (34 ูุฑุฉ).",
    "ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉุ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถุ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑูู."
]

QURAN_VERSES = [
    "ุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง ๏ดฟูฅ๏ดพ ููุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง ๏ดฟูฆ๏ดพ (ุงูุดุฑุญ:5-6)",
    "ููููู ููุชูููู ุงูููููู ููุฌูุนูู ููููู ููุฎูุฑูุฌูุง ๏ดฟูข๏ดพ ููููุฑูุฒููููู ูููู ุญูููุซู ููุง ููุญูุชูุณูุจู (ุงูุทูุงู:2-3)",
    "ุฑููุจูู ุฃูุฏูุฎูููููู ููุฏูุฎููู ุตูุฏููู ููุฃูุฎูุฑูุฌูููู ููุฎูุฑูุฌู ุตูุฏููู ููุงุฌูุนูู ูููู ููู ูููุฏูููู ุณูููุทูุงููุง ูููุตููุฑูุง (ุงูุฅุณุฑุงุก:80)",
    "ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู (ุขูุฉ ุงููุฑุณู)",
    "ููููู ููุชูููููููู ุนูููู ุงูููููู ูููููู ุญูุณูุจููู (ุงูุทูุงู:3)",
    "ููุฅูููู ุงูููููู ูููู ุงููุบููููุฑู ุงูุฑููุญูููู (ุงูุญุดุฑ:22)",
    "ููููู ุฑููุจูู ุฃููุฒูููููู ูููุฒูููุง ูููุจูุงุฑูููุง ููุฃููุชู ุฎูููุฑู ุงูููููุฒูููููู (ุงููุคูููู:29)",
    "ููุฐููููุฑู ููุฅูููู ุงูุฐููููุฑูููฐ ุชููููุนู ุงููููุคูููููููู (ุงูุฐุงุฑูุงุช:55)",
    "ููุฅูุฐูุง ุณูุฃููููู ุนูุจูุงุฏูู ุนููููู ููุฅููููู ููุฑููุจู ุฃูุฌููุจู ุฏูุนูููุฉู ุงูุฏููุงุนู ุฅูุฐูุง ุฏูุนูุงูู (ุงูุจูุฑุฉ:186)",
    "ููููุง ุชููููููููู ุฅููููุง ุจูุงูููููู ุนููููููู ุชููููููููุชู ููุฅููููููู ุฃููููุจู (ููุฏ:88)"
]

active_users = set()
verse_sent_today = set()

def get_algeria_time():
    """ุงูุญุตูู ุนูู ููุช ุงูุฌุฒุงุฆุฑ ูุน ุงูุชูุณูู"""
    now = datetime.utcnow() + timedelta(hours=1)  # UTC+1
    return now, now.strftime("%H:%M")

def get_random_verse_with_audio():
    """ุงูุญุตูู ุนูู ุขูุฉ ุนุดูุงุฆูุฉ ูุน ุฑุงุจุท ุงูุตูุช"""
    try:
        # ุงูุญุตูู ุนูู ุณูุฑุฉ ุนุดูุงุฆูุฉ
        surah = random.randint(1, 114)
        response = requests.get(f"https://api.alquran.cloud/v1/surah/{surah}/ar.alafasy")
        data = response.json()
        
        if data['code'] == 200:
            verses = data['data']['ayahs']
            verse = random.choice(verses)
            
            return {
                'text': verse['text'],
                'audio': verse['audio'],
                'surah_name': data['data']['name'],
                'surah_number': data['data']['number'],
                'ayah_number': verse['numberInSurah']
            }
    except Exception as e:
        logger.error(f"ุฎุทุฃ ูู ุฌูุจ ุงูุขูุฉ: {e}")
    
    return None

def send_morning_adhkar(context, chat_id):
    now, time_str = get_algeria_time()
    context.bot.send_message(
        chat_id, 
        f"๐ *ุฐูุฑ ุงูุตุจุงุญ* | {time_str}\n\n{random.choice(MORNING_ADHKAR)}", 
        parse_mode="Markdown"
    )

def send_evening_adhkar(context, chat_id):
    now, time_str = get_algeria_time()
    context.bot.send_message(
        chat_id, 
        f"๐ *ุฐูุฑ ุงููุณุงุก* | {time_str}\n\n{random.choice(EVENING_ADHKAR)}", 
        parse_mode="Markdown"
    )

def send_night_adhkar(context, chat_id):
    now, time_str = get_algeria_time()
    context.bot.send_message(
        chat_id, 
        f"๐ *ุฐูุฑ ุงูููู* | {time_str}\n\n{random.choice(NIGHT_ADHKAR)}", 
        parse_mode="Markdown"
    )

def send_daily_verse_with_audio(context):
    """ุฅุฑุณุงู ุขูุฉ ููููุฉ ูุน ุตูุช"""
    now, time_str = get_algeria_time()
    verse_data = get_random_verse_with_audio()
    
    if verse_data:
        for uid in active_users:
            try:
                # ุฅุฑุณุงู ุงููุต ุฃููุงู
                context.bot.send_message(
                    uid,
                    f"๐ *ุขูุฉ ูุฑุขููุฉ* | {time_str}\n\n"
                    f"{verse_data['text']}\n\n"
                    f"ุณูุฑุฉ {verse_data['surah_name']} - ุงูุขูุฉ {verse_data['ayah_number']}",
                    parse_mode="Markdown"
                )
                
                # ุซู ุฅุฑุณุงู ุงูุตูุช
                context.bot.send_audio(
                    uid,
                    audio=verse_data['audio'],
                    caption=f"๐ง ุชูุงูุฉ ุงูุขูุฉ ุงูุณุงุจูุฉ | {time_str}"
                )
            except Exception as e:
                logger.error(f"ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุขูุฉ ูููุณุชุฎุฏู {uid}: {e}")

def send_quran_audio(update: Update, context: CallbackContext):
    """ุฅุฑุณุงู ุชูุงูุฉ ุนุดูุงุฆูุฉ"""
    now, time_str = get_algeria_time()
    verse_data = get_random_verse_with_audio()
    
    if verse_data:
        try:
            update.message.reply_text(
                f"๐ ุชู ุงุฎุชูุงุฑ ุขูุฉ ูู ุณูุฑุฉ {verse_data['surah_name']} - ุงูุขูุฉ {verse_data['ayah_number']}"
            )
            context.bot.send_audio(
                update.effective_chat.id,
                audio=verse_data['audio'],
                caption=f"๐ง ุชูุงูุฉ ูุฑุขููุฉ | {time_str}\n"
                        f"ุณูุฑุฉ {verse_data['surah_name']} - ุงูุขูุฉ {verse_data['ayah_number']}"
            )
        except Exception as e:
            logger.error(f"ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุชูุงูุฉ: {e}")
            update.message.reply_text("โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุชูุงูุฉ")
    else:
        update.message.reply_text("โ๏ธ ุชุนุฐุฑ ุฌูุจ ุงูุชูุงูุฉุ ุญุงูู ูุงุญูุงู")

def start(update: Update, context: CallbackContext):
    now, time_str = get_algeria_time()
    uid = update.effective_user.id
    active_users.add(uid)
    
    start_msg = f"""
โจ *ูุฑุญุจุงู ุจู ูู ุจูุช ุงูุฃุฐูุงุฑ ูุงููุฑุขู* โจ

๐ ุชูููุช ุงูุฌุฒุงุฆุฑ: {time_str}

๐ข *ูููุฒุงุช ุงูุจูุช:*
- ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุณุงุก ุชููุงุฆูุงู
- ุขูุฉ ูุฑุขููุฉ ููุชูุจุฉ ููุณููุนุฉ ููููุงู
- ุชูุงูุงุช ูุฑุขููุฉ ุนูุฏ ุงูุทูุจ

โก๏ธ *ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:*
/start - ุนุฑุถ ุงูุฑุณุงูุฉ ุงูุชุฑุญูุจูุฉ
/quran - ุงูุญุตูู ุนูู ุชูุงูุฉ ูุฑุขููุฉ ุนุดูุงุฆูุฉ
/adhkar - ุฐูุฑ ุนุดูุงุฆู
/verse - ุขูุฉ ูุฑุขููุฉ ููุชูุจุฉ

ุชู ุชุทููุฑ ุงูุจูุช ุจูุงุณุทุฉ ุฎููู
"""
    update.message.reply_text(start_msg, parse_mode="Markdown")

def send_random_adhkar(update: Update, context: CallbackContext):
    now, time_str = get_algeria_time()
    all_adhkar = MORNING_ADHKAR + EVENING_ADHKAR + NIGHT_ADHKAR
    update.message.reply_text(
        f"๐ฟ *ุฐูุฑ* | {time_str}\n\n{random.choice(all_adhkar)}", 
        parse_mode="Markdown"
    )

def send_verse_command(update: Update, context: CallbackContext):
    """ุฅุฑุณุงู ุขูุฉ ููุชูุจุฉ ุนูุฏ ุงูุทูุจ"""
    now, time_str = get_algeria_time()
    verse_data = get_random_verse_with_audio()
    
    if verse_data:
        update.message.reply_text(
            f"๐ *ุขูุฉ ูุฑุขููุฉ* | {time_str}\n\n"
            f"{verse_data['text']}\n\n"
            f"ุณูุฑุฉ {verse_data['surah_name']} - ุงูุขูุฉ {verse_data['ayah_number']}",
            parse_mode="Markdown"
        )
    else:
        update.message.reply_text("โ๏ธ ุชุนุฐุฑ ุฌูุจ ุงูุขูุฉุ ุญุงูู ูุงุญูุงู")

def scheduled_jobs(context: CallbackContext):
    """ุงูููุงู ุงููุฌุฏููุฉ"""
    now, time_str = get_algeria_time()
    hour = now.hour
    
    # ุฅุฑุณุงู ุงูุฃุฐูุงุฑ ุญุณุจ ุงูููุช
    for uid in active_users:
        if 6 <= hour < 9:
            send_morning_adhkar(context, uid)
        elif 18 <= hour < 21:
            send_evening_adhkar(context, uid)
        elif 21 <= hour < 23:
            send_night_adhkar(context, uid)
    
    # ุฅุฑุณุงู ุขูุฉ ูุน ุตูุช ูุฑุฉ ูุงุญุฏุฉ ููููุงู ูู ุงูุณุงุนุฉ 8 ุตุจุงุญุงู
    if hour == 8 and now.minute == 0:
        send_daily_verse_with_audio(context)

def main():
    updater = Updater(BOT_TOKEN, use_context=True)
    dp = updater.dispatcher
    
    # ุชุนุฑูู ุงูุฃูุงูุฑ
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("quran", send_quran_audio))
    dp.add_handler(CommandHandler("adhkar", send_random_adhkar))
    dp.add_handler(CommandHandler("verse", send_verse_command))
    
    # ุงูุฌุฏููุฉ
    job_queue = updater.job_queue
    job_queue.run_repeating(scheduled_jobs, interval=3600, first=0)
    
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
