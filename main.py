import os
import time
import random
from datetime import datetime
import requests
import logging
from telegram import Bot, Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

# ุฅุนุฏุงุฏุงุช ุงูุจูุช
BOT_TOKEN = "ุชููู_ุจูุชู_ููุง"
ADMIN_ID = 123456789  # ุฃุถู ุขูุฏู ุญุณุงุจู ููุง

# ููุงุฆู ุงูุฃุฐูุงุฑ ุงููุจูุฑุฉ ูุงููุชููุนุฉ
MORNING_ADHKAR = [
    "ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุจู ุฃุตุจุญูุงุ ูุจู ุฃูุณููุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุดูุฑ.",
    "ุณุจุญุงู ุงููู ูุจุญูุฏู ุนุฏุฏ ุฎููู ูุฑุถุง ููุณู ูุฒูุฉ ุนุฑุดู ููุฏุงุฏ ูููุงุชู.",
    "ุงูููู ุฅูู ุฃุตุจุญุช ููู ูู ูุนูุฉ ูุนุงููุฉ ูุณุชุฑุ ูุฃุชู ูุนูุชู ุนูู ูุนุงููุชู ูุณุชุฑู ูู ุงูุฏููุง ูุงูุขุฎุฑุฉ.",
    "ุฃุตุจุญูุง ุนูู ูุทุฑุฉ ุงูุฅุณูุงูุ ููููุฉ ุงูุฅุฎูุงุตุ ูุฏูู ูุจููุง ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ ูููุฉ ุฃุจููุง ุฅุจุฑุงููู ุญูููุงู ูุณููุงู ููุง ูุงู ูู ุงููุดุฑููู.",
    "ุงูููู ูุง ุฃุตุจุญ ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ.",
    "ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ููุ ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู.",
    "ุงูููู ุฅูู ุฃุณุฃูู ุนููุงู ูุงูุนุงูุ ูุฑุฒูุงู ุทูุจุงูุ ูุนููุงู ูุชูุจูุงู.",
    "ุณุจุญุงู ุงููู ุงูุนุธูู ูุจุญูุฏูุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู."
]

EVENING_ADHKAR = [
    "ุฃูุณููุง ูุฃูุณู ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุจู ุฃูุณููุงุ ูุจู ุฃุตุจุญูุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุตูุฑ.",
    "ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู.",
    "ุงูููู ุฅูู ุฃูุณูุช ููู ูู ูุนูุฉ ูุนุงููุฉ ูุณุชุฑุ ูุฃุชู ูุนูุชู ุนูู ูุนุงููุชู ูุณุชุฑู ูู ุงูุฏููุง ูุงูุขุฎุฑุฉ.",
    "ุฃูุณููุง ุนูู ูุทุฑุฉ ุงูุฅุณูุงูุ ููููุฉ ุงูุฅุฎูุงุตุ ูุฏูู ูุจููุง ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ ูููุฉ ุฃุจููุง ุฅุจุฑุงููู ุญูููุงู ูุณููุงู ููุง ูุงู ูู ุงููุดุฑููู.",
    "ุงูููู ูุง ุฃูุณู ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ.",
    "ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ููุ ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู.",
    "ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ ูู ุงูุฏููุง ูุงูุขุฎุฑุฉุ ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ ูู ุฏููู ูุฏููุงู ูุฃููู ููุงูู.",
    "ุณุจุญุงู ุงููู ุงูุนุธูู ูุจุญูุฏูุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุฃุนูุฐ ุจุงููู ูู ุงูุดูุทุงู ุงูุฑุฌูู: {ุขูุฉ ุงููุฑุณู}"
]

NIGHT_ADHKAR = [
    "ุจุงุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู.",
    "ุขูุฉ ุงููุฑุณู: ุงููู ูุง ุฅูู ุฅูุง ูู ุงูุญู ุงููููู ูุง ุชุฃุฎุฐู ุณูุฉ ููุง ููู ูู ูุง ูู ุงูุณูุงูุงุช ููุง ูู ุงูุฃุฑุถ...",
    "ุฃุนูุฐ ุจุฑุจ ุงููููุ ูู ุดุฑ ูุง ุฎููุ ููู ุดุฑ ุบุงุณู ุฅุฐุง ููุจุ ููู ุดุฑ ุงูููุงุซุงุช ูู ุงูุนูุฏุ ููู ุดุฑ ุญุงุณุฏ ุฅุฐุง ุญุณุฏ.",
    "ุฃุนูุฐ ุจุฑุจ ุงููุงุณุ ููู ุงููุงุณุ ุฅูู ุงููุงุณุ ูู ุดุฑ ุงููุณูุงุณ ุงูุฎูุงุณุ ุงูุฐู ููุณูุณ ูู ุตุฏูุฑ ุงููุงุณุ ูู ุงูุฌูุฉ ูุงููุงุณ.",
    "ุงูููู ุฑุจ ุงูุณูุงูุงุช ูุฑุจ ุงูุฃุฑุถ ูุฑุจ ุงูุนุฑุด ุงูุนุธููุ ุฑุจูุง ูุฑุจ ูู ุดูุกุ ูุงูู ุงูุญุจ ูุงููููุ ูููุฒู ุงูุชูุฑุงุฉ ูุงูุฅูุฌูู ูุงููุฑูุงูุ ุฃุนูุฐ ุจู ูู ุดุฑ ูู ุดูุก ุฃูุช ุขุฎุฐ ุจูุงุตูุชูุ ุงูููู ุฃูุช ุงูุฃูู ูููุณ ูุจูู ุดูุกุ ูุฃูุช ุงูุขุฎุฑ ูููุณ ุจุนุฏู ุดูุกุ ูุฃูุช ุงูุธุงูุฑ ูููุณ ูููู ุดูุกุ ูุฃูุช ุงูุจุงุทู ูููุณ ุฏููู ุดูุกุ ุงูุถ ุนูุง ุงูุฏูู ูุฃุบููุง ูู ุงูููุฑ.",
    "ุจุณู ุงููู ูุถุนุช ุฌูุจูุ ุงูููู ุงุบูุฑ ูู ุฐูุจูุ ูุฃุฎุณุฆ ุดูุทุงููุ ููู ุฑูุงููุ ูุงุฌุนููู ูู ุงููุฏู ุงูุฃุนูู.",
    "ุงูููู ุฃุณููุช ููุณู ุฅูููุ ููุฌูุช ูุฌูู ุฅูููุ ูููุถุช ุฃูุฑู ุฅูููุ ูุฃูุฌุฃุช ุธูุฑู ุฅูููุ ุฑุบุจุฉ ูุฑูุจุฉ ุฅูููุ ูุง ููุฌุฃ ููุง ููุฌุง ููู ุฅูุง ุฅูููุ ุขููุช ุจูุชุงุจู ุงูุฐู ุฃูุฒูุชุ ูุจูุจูู ุงูุฐู ุฃุฑุณูุช.",
    "ุณุจุญุงู ุงููู (33 ูุฑุฉ)ุ ุงูุญูุฏ ููู (33 ูุฑุฉ)ุ ุงููู ุฃูุจุฑ (34 ูุฑุฉ).",
    "ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.",
    "ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉุ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถุ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑูู."
]

QURAN_VERSES = [
    "ุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง ๏ดฟูฅ๏ดพ ููุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง ๏ดฟูฆ๏ดพ (ุงูุดุฑุญ:5-6)",
    "ููููู ููุชูููู ุงูููููู ููุฌูุนูู ููููู ููุฎูุฑูุฌูุง ๏ดฟูข๏ดพ ููููุฑูุฒููููู ูููู ุญูููุซู ููุง ููุญูุชูุณูุจู (ุงูุทูุงู:2-3)",
    "ุฑููุจูู ุฃูุฏูุฎูููููู ููุฏูุฎููู ุตูุฏููู ููุฃูุฎูุฑูุฌูููู ููุฎูุฑูุฌู ุตูุฏููู ููุงุฌูุนูู ูููู ููู ูููุฏูููู ุณูููุทูุงููุง ูููุตููุฑูุง (ุงูุฅุณุฑุงุก:80)",
    "ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู (ุขูุฉ ุงููุฑุณู)",
    "ููููู ููุชูููููููู ุนูููู ุงูููููู ูููููู ุญูุณูุจููู (ุงูุทูุงู:3)",
    "ููุฅูููู ุงูููููู ูููู ุงููุบููููุฑู ุงูุฑููุญูููู (ุงูุญุดุฑ:22)",
    "ููููู ุฑููุจูู ุฃููุฒูููููู ูููุฒูููุง ูููุจูุงุฑูููุง ููุฃููุชู ุฎูููุฑู ุงูููููุฒูููููู (ุงููุคูููู:29)",
    "ููุฐููููุฑู ููุฅูููู ุงูุฐููููุฑูููฐ ุชููููุนู ุงููููุคูููููููู (ุงูุฐุงุฑูุงุช:55)",
    "ููุฅูุฐูุง ุณูุฃููููู ุนูุจูุงุฏูู ุนููููู ููุฅููููู ููุฑููุจู ุฃูุฌููุจู ุฏูุนูููุฉู ุงูุฏููุงุนู ุฅูุฐูุง ุฏูุนูุงูู (ุงูุจูุฑุฉ:186)",
    "ููููุง ุชููููููููู ุฅููููุง ุจูุงูููููู ุนููููููู ุชููููููููุชู ููุฅููููููู ุฃููููุจู (ููุฏ:88)"
]

QURAN_AUDIO = [
    "https://server.mp3quran.net/s_gmd/001.mp3",  # ุงููุงุชุญุฉ
    "https://server.mp3quran.net/s_gmd/112.mp3",  # ุงูุฅุฎูุงุต
    "https://server.mp3quran.net/s_gmd/113.mp3",  # ุงูููู
    "https://server.mp3quran.net/s_gmd/114.mp3",  # ุงููุงุณ
    "https://server.mp3quran.net/s_gmd/002.mp3",  # ุงูุจูุฑุฉ (ุขูุฉ ุงููุฑุณู)
    "https://server.mp3quran.net/s_gmd/036.mp3",  # ูุณ
    "https://server.mp3quran.net/s_gmd/067.mp3",  # ุงูููู
    "https://server.mp3quran.net/s_gmd/055.mp3",  # ุงูุฑุญูู
    "https://server.mp3quran.net/s_gmd/078.mp3",  # ุงููุจุฃ
    "https://server.mp3quran.net/s_gmd/093.mp3"   # ุงูุถุญู
]

# ูุชุบูุฑุงุช ุงูุจูุช
active_users = set()
verse_sent_today = set()

# ุฅุนุฏุงุฏ ุงูุณุฌูุงุช
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def get_algeria_time():
    """ุงูุญุตูู ุนูู ุชูููุช ุงูุฌุฒุงุฆุฑ (UTC+1)"""
    return (datetime.utcnow().hour + 1) % 24

def start(update: Update, context: CallbackContext):
    """ูุนุงูุฌุฉ ุฃูุฑ /start"""
    user = update.effective_user
    user_id = user.id
    
    if user_id not in active_users:
        active_users.add(user_id)
        
        welcome_msg = (
            "โจ *ูุฑุญุจุงู ุจู ูู ุจูุช ุงูุฃุฐูุงุฑ ูุงููุฑุขู* โจ\n\n"
            "ุชู ุชุทููุฑ ูุฐุง ุงูุจูุช ุจูุงุณุทุฉ *ุฎููู*\n"
            "ุณูู ุชุตูู ุงูุฃุฐูุงุฑ ุงูููููุฉ ุชููุงุฆูุงู ุญุณุจ ุงูุชูููุช:\n"
            "- ุฃุฐูุงุฑ ุงูุตุจุงุญ (6-9 ุต)\n"
            "- ุฃุฐูุงุฑ ุงููุณุงุก (6-9 ู)\n"
            "- ุฃุฐูุงุฑ ุงูููู (9-11 ู)\n\n"
            "๐ *ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:*\n"
            "/start - ุนุฑุถ ูุฐู ุงูุฑุณุงูุฉ\n"
            "/quran - ุงุณุชูุงุน ุฅูู ุชูุงูุฉ ูุฑุขููุฉ\n"
            "/adhkar - ุนุฑุถ ุฃุฐูุงุฑ ูุชููุนุฉ\n"
            "/verse - ุขูุฉ ูุฑุขููุฉ ุนุดูุงุฆูุฉ\n\n"
            "ุณูุชู ุฅุฑุณุงู ุขูุฉ ูุฑุขููุฉ ููุชูุจุฉ ูู ุณุงุนุฉ ุฅู ุดุงุก ุงููู"
        )
        
        context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=welcome_msg,
            parse_mode="Markdown"
        )
        
        # ุฅุฑุณุงู ุฃูู ุฐูุฑ ุจุนุฏ ุงูุชุณุฌูู
        current_hour = get_algeria_time()
        if 6 <= current_hour < 9:
            send_morning_adhkar(context, user_id)
        elif 18 <= current_hour < 21:
            send_evening_adhkar(context, user_id)
        elif 21 <= current_hour < 23:
            send_night_adhkar(context, user_id)

def send_morning_adhkar(context: CallbackContext, chat_id):
    """ุฅุฑุณุงู ุฃุฐูุงุฑ ุงูุตุจุงุญ"""
    zikr = random.choice(MORNING_ADHKAR)
    context.bot.send_message(
        chat_id=chat_id,
        text=f"๐ *ุฐูุฑ ุงูุตุจุงุญ*\n\n{zikr}",
        parse_mode="Markdown"
    )

def send_evening_adhkar(context: CallbackContext, chat_id):
    """ุฅุฑุณุงู ุฃุฐูุงุฑ ุงููุณุงุก"""
    zikr = random.choice(EVENING_ADHKAR)
    context.bot.send_message(
        chat_id=chat_id,
        text=f"๐ *ุฐูุฑ ุงููุณุงุก*\n\n{zikr}",
        parse_mode="Markdown"
    )

def send_night_adhkar(context: CallbackContext, chat_id):
    """ุฅุฑุณุงู ุฃุฐูุงุฑ ุงูููู"""
    zikr = random.choice(NIGHT_ADHKAR)
    context.bot.send_message(
        chat_id=chat_id,
        text=f"๐ *ุฐูุฑ ุงูููู*\n\n{zikr}",
        parse_mode="Markdown"
    )

def send_random_verse(context: CallbackContext):
    """ุฅุฑุณุงู ุขูุฉ ูุฑุขููุฉ ุนุดูุงุฆูุฉ ูู ุณุงุนุฉ"""
    today = datetime.now().strftime("%Y-%m-%d")
    
    for user_id in active_users:
        verse = random.choice(QURAN_VERSES)
        while verse in verse_sent_today:
            verse = random.choice(QURAN_VERSES)
            
        verse_sent_today.add(verse)
        
        context.bot.send_message(
            chat_id=user_id,
            text=f"๐ *ุขูุฉ ูุฑุขููุฉ*\n\n{verse}",
            parse_mode="Markdown"
        )

def send_quran_audio(update: Update, context: CallbackContext):
    """ุฅุฑุณุงู ุชูุงูุฉ ูุฑุขููุฉ"""
    audio = random.choice(QURAN_AUDIO)
    context.bot.send_audio(
        chat_id=update.effective_chat.id,
        audio=audio,
        caption="๐ง ุชูุงูุฉ ูุฑุขููุฉ"
    )

def send_random_adhkar(update: Update, context: CallbackContext):
    """ุฅุฑุณุงู ุฃุฐูุงุฑ ูุชููุนุฉ"""
    all_adhkar = MORNING_ADHKAR + EVENING_ADHKAR + NIGHT_ADHKAR
    zikr = random.choice(all_adhkar)
    
    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"๐ฟ *ุฐูุฑ ูุชููุน*\n\n{zikr}",
        parse_mode="Markdown"
    )

def send_random_verse_command(update: Update, context: CallbackContext):
    """ุฅุฑุณุงู ุขูุฉ ูุฑุขููุฉ ุนูุฏ ุงูุทูุจ"""
    verse = random.choice(QURAN_VERSES)
    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"๐ *ุขูุฉ ูุฑุขููุฉ*\n\n{verse}",
        parse_mode="Markdown"
    )

def scheduled_jobs(context: CallbackContext):
    """ุงูููุงู ุงููุฌุฏููุฉ"""
    current_hour = get_algeria_time()
    
    # ุฅุฑุณุงู ุงูุฃุฐูุงุฑ ุญุณุจ ุงูููุช
    if 6 <= current_hour < 9:
        for user_id in active_users:
            send_morning_adhkar(context, user_id)
    elif 18 <= current_hour < 21:
        for user_id in active_users:
            send_evening_adhkar(context, user_id)
    elif 21 <= current_hour < 23:
        for user_id in active_users:
            send_night_adhkar(context, user_id)
    
    # ุฅุฑุณุงู ุขูุฉ ูุฑุขููุฉ ูู ุณุงุนุฉ
    send_random_verse(context)

def error_handler(update: Update, context: CallbackContext):
    """ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก"""
    logger.error(msg="ุญุฏุซ ุฎุทุฃ ูู ุงูุจูุช:", exc_info=context.error)

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    updater = Updater(token=BOT_TOKEN, use_context=True)
    dispatcher = updater.dispatcher

    # ุชุนุฑูู ุงูุฃูุงูุฑ
    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("quran", send_quran_audio))
    dispatcher.add_handler(CommandHandler("adhkar", send_random_adhkar))
    dispatcher.add_handler(CommandHandler("verse", send_random_verse_command))

    # ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
    dispatcher.add_error_handler(error_handler)

    # ุงูููุงู ุงููุฌุฏููุฉ
    job_queue = updater.job_queue
    job_queue.run_repeating(scheduled_jobs, interval=3600, first=0)  # ูู ุณุงุนุฉ

    # ุจุฏุก ุงูุจูุช
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
